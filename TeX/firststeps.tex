\chapter{Preparation}
\label{sec:firststeps}

\section{Initial Researches}
Some research on the working principle of Alphasense \chem{NO_2} electrochemical sensor had to be made prior to the initialization of the mechanical and electronical sections of this project. The paper /////// on previous experiments conducted in Boston, United States of America was very helpful to get a first idea about how I could start building my project designed for \chem{NO_2} density measurements. In another paper about a research conducted in Zurich, Switzerland, /// it is emphasized that it is quite expensive to build a gas pollutant measurement station sensitive to a certain gas and thus low cost sensor stations play a very important role in collecting environmental data. \par 
My goal was to build a functioning circuit, to get meaningful data from it and to document the entire process of my project well, and the researchs and the papers I read gave me even more motivation about how topical air pollution is and thus how important it is to try to build a low-cost air pollutant density measuring station and to collect useful environmental data.

\section{Getting a Better Understanding}
I had to read the application notes on the Alphasense Webpage to get a better understanding of the inner structure as well as the pinout of the sensor and for this purpose I began to study the /////////////// (kaynak) (inner structure). As I started to understand which electrode of the sensor was responsible for which purpose, I began to get an idea of how I could build my own circuit, which would be able to supply enough current to the sensor and output voltage, linearly proportional to the concentration of the air pollutant, which in other words is the ppb level of \chem{NO_2} in the air. \par
Afterwards I started to read //////////////////(designing a circuit), which gave me a starting point for the circuit. In diagram ////// from //// you can see a circuit design for a three-electrode sensor. I was actaully working with the sensor NO2-B43F, which is a four-electrode sensor, but this circuit schematic was nonetheless a good point to start building and testing the circuit.

\chapter{Putting Into Practice}

\section{Building the Initial Circuit}

\subsection{Hardware}
\subsubsection{Circuit Design}
In order to understand the circuit fully, we must first study the structure and the pinout of the NO2-B43F sensor. There are 4 electrodes of the electrochemical sensor: Working electrode, reference electrode, counter electrode and auxilliary electrode. The reference electrode holds the potential of the working electrode stable at a certain level, which is equal to the potential of the reference electrode itself. This potential must be fixed to ensure a stable outcome from the sensor and the circuit. The counter electrode must be able to supply enough current to the working electrode, so that the current through the counter and working electrode can be translated and amplified to create the output voltage.\par
The A4 and B4 sensors have two sensing electrodes: The working electrode and the auxiliary electrode. The main purpose of the working electrode is to react to the \chem{NO_2} in the air and thus create a current flow proportional to the gas concentration. In other words the working electrode responds to gas concentration whereas the auxiliary electrode does not respond to gas. The idea is to be able to correct for zero drifts using the auxiliary electrode output. It is thus recommended that at the beginning both electrode outputs are recorded (Working electrode and auxiliary electrode) rather than applying a correction directly.\par
The circuit in general comprises of operational amplifiers, a couple of capacitors to reduce noise from the sensor and various resistors to get the desired gain from the operational amplifiers.In Figure ////// the detailed circuit schematic is given. On the left hand side of the circuit the NO2-B43F sensor is connected via 3 electrodes to the circuit. This schematic is for 3 electrode sensors like previously mentioned, so the auxilliary electrode is left out. The power connections of the operational amplifiers are also not shown, however they must be provided a regulated and high enough voltage to encompass the maxima of the output voltage. In addition to that the power supply must be rated with high enough current to be able to supply the required current drawn by the counter electrode and the operational amplifiers themselves.\par
The circuit consists of 2 stages of amplifiers. The first stage is the control circuit, whose main objective is to supply the counter electrode with enough current so that the current required by the working electrode is met. The potential at the reference electrode, namely the reference voltage is connected to the inverting input of the operational amplifier. It is important that near to zero current is drawn from the reference electrode, so an op amp with minimal input bias current is recommended. \textbf{alinti}
Since the current control part of the circuit can already supply the counter electrode with enough current, the next step is to build the sensing part of the circuit, namely the current measuring stage. In this stage, the current through the counter and working electrode flows through the sensing resistor R\textsubscript{Load}, which in return creates a voltage on the inverting input of the second operational amplifier IC1. As it is mentioned before this current through R\textsubscript{Load} is linearly proportional to the gas concentration in the air. As a reminder our main goal is to measure the amplitude of this current created by the working electrode, which gives us information about the concentration of \chem{NO_2}. That is where IC1 comes into play. The voltage difference between the inputs of IC1 is amplified (multiplied) by a very large number and is created on the output of IC1. However this high voltage is fed back to the inverting input over the resistor R4, which increases the voltage on the inverting input and thus reduces the voltage difference between the inputs of the operational amplifier. As a result the output voltage is reduced and so is the influence of the output on the inverting input voltage. This pendulum saturates at a specific voltage level, which is equal to the input voltage multiplied by a constant determined by the resistors R\textsubscript{Load} and R4. This constant i.e. the gain of the amplifier is equal to \textbf{formÃ¼l}. \par
In conclusion the control stage supplies the required current by the counter electrode to the sensor, which is created by the potential difference between the counter and working electrodes. The current then flows through the sensing resistor  R\textsubscript{Load} creating a voltage on the inverting input of IC1. This input voltage is then multiplied by the gain and in the end creates the output voltage.

\subsubsection{Microcontroller}
For this project I decided to use an Arduino Uno board, since it is inexpensive and easy to use. I used a 12 Volts 1 Amp wall adapter for the power supply of the Arduino board. The Arduino board has 5V and 3.3V voltage regulator onboard. Since this circuit does not consist any component which requires high current, the voltage regulation from 12 Volts down to 5 Volts does not dissipate any excessive heat. \par
I put all the parts depicted in the circuit design together on a breadboard. For the power supply needed for the operational amplifiers I simply used the $5V$ and $GND$ power supply lines of the Arduino Uno board. The output of IC1 is connected to the analog input $A0$ on the board, which makes the voltage level readings possible. 


\subsection{Software}
The Arduino Uno board is simply an I/O device with several output and input pins. Through programming via the Arduino Integrated Development Environment (IDE) these pins can be accessed and thus works as an interface between the circuit and the computer. It is capable of reading the voltage connected to its input, sending it to the computer via serial communication. These values sent from the Arduino are then displayed on the computer screen via Arduino Integrated Development Environment (IDE). But in order to let the Arduino board know which data to send and at which frequency, we first have to program it using the same Arduino IDE.\par
Arduino can supply voltage and read voltage inputs up to 5 Volts. Analog inputs of the Arduino divide the continuous voltage range from 0 Volts to the analog reference voltage into 1024 discrete steps while digital outputs with Pulse Width Modulation (PWM) feature can supply 1024 different levels of voltage from 0 Volts up to a maximum of 5 Volts. Digital outputs without this feature can only supply either 0 Volts (LOW) or 5 Volts (HIGH). For this purpose I connected the output pin of the operational amplifier in the last stage to one of the analog inputs on the Arduino. This way I could read the voltage level on the output of the operational amplifier at a high frequency (9600 bits per second) and thus get enough data to plot the output signal with sufficient resolution. \par
For this reason I wrote a simple Arduino code using the Arduino IDE. This code consists of two standart main functions, namely $setup()$ and $loop()$. The $setup$ function is called once when the sketch starts and runs only once after each powerup or reset of the Arduino board \textbf{Arduino setup aliniti}. Afterwards the $loop$ function is called and loops consecutively as the name suggests \textbf{Arduino loop aliniti}. In $setup()$ the serial communication speed, at which the microcontroller Atmega328p of the Arduino Uno is going to communicate with the computer, set with the function $Serial.begin()$ at 9600 bits per second. In $loop$ the function $Serial.print()$ is then used to print the ///////////// values on the serial monitor or on the serial plotter. For testing purposes it is recommended to use the serial monitor embedded in the Arduino IDE, since it is sufficient to show the voltage values at the analog pin on the computer. Alternatively the serial plotter, again embedded in the Arduino IDE, can be used to plot the data and thus to create sample-voltage graph. At the end of the code I added the $delay()$ function, which "[p]auses the program for the amount of time (in milliseconds) specified as parameter." \textbf{delay alinti}. In the code I have written the program waits for 50 milliseconds before acquiring the next value. This way it becomes more pleasant to read the data printed on the serial monitor.

\subsection{Discussion}
This design was a success in terms of testing the sensor and the circuit. The values printed on the serial monitor showed us that the sensor reacted to the \chem{NO_2} concentration in the air. However it was lacking of protection against electrical noise and the values were not similar to the nominal values which were determined with the help of the Individual Sensor Board (ISB) from Alphasense. Most importantly the auxiliiary electrode was left out, which is why a correction for zero drifts was impossible with this circuit design alone. An improvement of the circuit was needed for better results, namely for the output data to get closer to the nominal values of the ISB circuit. Therefore I started to study and eventually build the circuit explained in the next section.  


\section{Realising the Last Circuit}
\subsection{Hardware}
\textbf{devre resmi} The circuit in general consists of 3 operational amplifiers, a couple of capacitors to reduce noise from the power supply and various resistors to get the required output voltage to input voltage ratio from each operational amplifier. Unlike the previous circuit design, the auxilliary electrode is included in this schematic, which will help us in the future to make zero drift corrections through programming and thus better results outputted from the circuit. Additionally the subcircuit for the low-dropout DC linear voltage regulator $MCP1702T25$  is also depicted in detail. Lastly the power supply subcircuit of the operational amplifiers is included.

\subsubsection{Main Circuit}
This design consists of two branches which lead to two different outputs. The working electrode of the sensor leads to the first branch and thus the first output $O/P1$, while the auxilliary electrode leads to the second output $O/P2$. However both branches are identical copies of each other. The main reason to build two identical copies of a branch is to seperate the working and the auxilliary electrode from each other in order to avoid any interference between the two electrodes. Like mentioned before, the auxilliary electrode does not react to \chem{NO_2} and thus the voltage level at $O/P2$ must not change depending on the \chem{NO_2} density in the air. Additionally it is to notice that two different operational amplifier ICs, namely two seperate $LT6011$ chips are used in order to seperate the two branches better. The operational amplifiers $U4A$ and $U4B$ constitutes one $LT6011$, while $U1A$ and $U1B$ constitutes the second IC. The last operational amplifier $U2$ is the IC $TLV2211$ which consists only one operational amplifier. Although the two different ICs have similar features, $TLV2211$ is more efficient in power consumption and in spatial terms since the $LT6011$ has a bigger packaging than the $TLV2211$ and consumes more energy \textbf{TLV datasheet + LT datasheet}.\par
The first stage of the circuit is the same as the initial design explained in the previous section. The only difference is that the capacitor $C2$ in the initial design is left out in this schematic, which is not necessary for this operational amplifier. \textbf{alinti pot circuit} Since this stage is explained in detail in the previous section, it is not needed to explain it again. \par 
After the first stage the circuit divides into 2 branches through the working and the auxilliary electrodes of the sensor. Like mentioned before these branches are identical, so it is more meaningful to explain only the branch starting from the working electrode in detail as the same logic can be applied to the branch starting from the auxilliary electrode leading to $O/P2$.\par
$V_{mid}1$ is directly connected to the output of the voltage regulator and has a potential of 2.5 Volts, which is explained in the next section in detail. The current flowing through $R15$ creates a voltage difference between its two ends, namely the working electrode and the inverting input of $U4B$. Since the potential of the working electrode is equal to the reference electrode and thus to 2.5 Volts, the voltage on the inverting input is higher than 2.5 Volts and thus is also higher than $V_{mid}1$, which is connected to the non-inverting input of the operational amplifier. As the \chem{NO_2} concentration gets higher, the current flowing through $R15$ becomes greater. For this reason the voltage difference between the two inputs of $U4C$ changes linearly proportional to the ppb level of \chem{NO_2}. This voltage difference gets amplified through $U4B$. The amplifying factor is equal to the \textbf{formula} and thus the outputted voltage from $U4B$ is equal to \textbf{formula}. The amplified voltage created at the output of $U4A$ goes into the inverting input of the last operational amplifier on this branch $U2$. The voltage level on the non-inverting input of $U2$ is determined by the voltage divider circuit consisted of $R29$, $R30$, $R8$, $R7A$ and $R9$. For this reason the voltage level of the non-invertin input is between 0 and 2.5 Volts. The voltage difference between the inputs of $U2$ is then multiplied by the gain of the operational amplifier, which is determined by the resistors $R6A$, $R4$ and $R3$. The same formula used for the earlier stage can be applied here, while the input resistor $R_{in}$ is $R6A$ and the value of the feedback resistor $R_f$ is equal to the sum of the values of $R4$ and $R3$, as they are connected in series. The voltage outputted from $U2$ is approximately equal to the output voltage, since the resistor $R1$ has a much greater value than $R3$ and has a negligible effect on the output voltage. $R1$ and the capacitor $C3$ are against noise at the output of the circuit $O/P1$.\par 
In conclusion the working principle of the main circuit can be summarized as follows: The voltage  output at $O/P1$ is the current created through the voltage difference between the working and the counter electrode translated to voltage with the help of resistors and amplified through 2 stages of operational amplifiers.\par 
The voltage levels at $O/P1$ and $O/P2$ are supplied to the analog inputs of the Arduino board and then gets printed on computer. Since the voltage at $O/P1$ is a translation of the working electrode and the voltage at $O/P2$ is a translation of the auxilliary electrode, both outputs can be used for noise reduction and zero drift correnction which leads to more reliable results than the data outputted using the initial design.


\subsubsection{Voltage Regulator Subcircuit}
On the bottom left corner the voltage regulator subcircuit is to be observed. This part of the schematic consists of a low-dropout DC linear voltage regulator $MCP1702T25$, a Zener diode with 6.8V Zener voltage, a electrolytic capacitor and various resistors and ceramic capacitors. The $MCP1702T25$ receives the input voltage at its $V_{in}$ pin and translates it to a regulated 2.5V potential level at $V_{out}$. The last pin depicted as $Adj$ in the schematic is simply connected to $GND$. The input voltage at $V_{in}$ is also regulated with an external voltage regulator $L7806CV$, which converts the 12V outputted from the wall adapter down to 6 Volts. The Zener diode $D2$ cuts off any excess voltage higher than 6.8 Volts by shorting $V_{in}$ with $GND$. Therefore it is dismissable since the 6 Volts input voltage is outputted from the $L7806CV$ voltage regulator and is less than 6.8 Volts at all times. The resistor $R16$ is connected to an unregulated voltage supply, and therefore is also not necessary in our circuit. On the output side of the voltage regulator the resistors $R21$, $R19$, $R27$ and $R28$ constitutes a voltage divider circuit which creates the voltage level depicted as $V_{off}1$. $V{pot}1$, $V{pot}2$, $V{ce}1$ and $V{mid}1$ are all connected directly to $V{out}$ and thus have the same 2.5V potential. The capacitors $C5$, $C12$ and $C13$ cuts out the AC part of the input and output voltages and thus reduces the overall noise ratio at the outputs $O/P1$ and $O/P2$.

\subsubsection{Power Supply of the Operational Amplifiers}

The operational amplifiers depicted as $U1C$ and $U4C$ are connected to the 6V regulated voltage level outputted from the $L7806CV$. The capacitors $C2$ and $C8$ are in parallel to the ICs and thus shorts the AC component of the input voltage while staying open for the DC section. This results in a more stabilized input voltage for the operational amplifier ICs and therefore reduces noise overall in the circuit. The single operational amplifier IC $TLV2211$ is also connected in parallel to the two $LT6011$ ICs, which is not depicted in this circuit schematic.

\subsection{Software}


   
   
   
   
%sokakta test -> discussion

